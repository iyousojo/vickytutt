<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><title>Manage Orders | Vicky's Admin</title>
  <link rel="stylesheet" href="admin.css" />
  <style>
    /* Status Badge Styles */
    .status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: capitalize;
    }
    .status.pending { background: #fff3cd; color: #856404; }
    .status.paid { background: #d4edda; color: #155724; }
    .status.shipped { background: #cce5ff; color: #004085; }
    
    .view-btn {
        background: #1a1a1a;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
    }
    .view-btn:hover { background: #444; }
  </style>
</head>
<body>
  <header class="topbar"><h2>Customer Orders</h2></header>
  <nav class="sidebar" id="sidebar">
    <a href="admin.html">Dashboard</a>
    <a href="adminorder.html">Add Product</a>
    <a href="adminproduct.html">Product List</a>
    <a href="orders.html" class="active">Orders</a>
    <a href="#" onclick="logoutAdmin()">Logout</a>
  </nav>

  <main class="content">
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f8f9fa; border-bottom: 2px solid #eee;">
            <tr>
              <th style="padding: 15px; text-align: left;">Order ID</th>
              <th style="text-align: left;">Customer</th>
              <th style="text-align: left;">Items</th>
              <th style="text-align: left;">Amount</th>
              <th style="text-align: left;">Status</th>
              <th style="text-align: center;">Action</th>
            </tr>
          </thead>
          <tbody id="orderList">
              </tbody>
        </table>
    </div>
  </main>

  <script src="fetch.js"></script>
 
<script>
  async function loadOrdersTable() {
    const tableBody = document.getElementById('orderList');
    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Fetching orders...</td></tr>';
    
    try {
        const result = await fetchAllOrders();
        
        // We look for result.success because your controller sends { success: true, data: orders }
        if (result.success && result.data.length > 0) {
            tableBody.innerHTML = result.data.map(order => {
                
                // 1. Handle Order Items from the Array
                const itemsHtml = order.items.map(item => `
                    <div style="margin-bottom: 8px; border-left: 2px solid #ddd; padding-left: 8px;">
                        <span style="display:block; font-weight: 600;">${item.name}</span>
                        <span style="font-size: 0.75rem; color: #666;">
                            Size: <strong>${item.size || 'N/A'}</strong> | Qty: ${item.qty}
                        </span>
                    </div>
                `).join('');

                // 2. Format the Date (using createdAt from your schema)
                const orderDate = new Date(order.createdAt).toLocaleDateString();

                return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 15px;">
                            <strong>#${order._id.slice(-5).toUpperCase()}</strong><br>
                            <small style="color:gray;">${orderDate}</small>
                        </td>
                        <td>
                            <strong>${order.userId?.firstName || 'Guest'}</strong><br>
                            <small style="color:gray;">${order.userId?.email || 'No email'}</small>
                        </td>
                        <td style="padding: 10px 0;">${itemsHtml}</td>
                        <td>â‚¦${Number(order.totalAmount || 0).toLocaleString()}</td>
                        <td>
                            <span class="status ${order.status}">
                                ${order.status}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <button class="view-btn" onclick="updateStatus('${order._id}')">Update</button>
                        </td>
                    </tr>
                `;
            }).join('');
        } else {
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">No orders found.</td></tr>`;
        }
    } catch (error) {
        console.error("Table Load Error:", error);
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:red;">Connection Error.</td></tr>';
    }
}

// Initial load
document.addEventListener('DOMContentLoaded', loadOrdersTable);
</script>
</body>
</html>