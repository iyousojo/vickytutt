<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vicky's Collection | Your Bag</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Professional Cart UI */
        .cart-overlay {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000;
        }
        .cart-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 500px;
            margin-left: auto;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        .cart-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-items {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .cart-item {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            border-bottom: 1px solid #fafafa;
            padding-bottom: 15px;
        }
        .cart-item-img {
            width: 80px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }
        .item-details { flex-grow: 1; }
        .item-name { display: block; font-weight: 500; margin-bottom: 5px; }
        .item-price { font-weight: 600; color: #1a1a1a; }
        
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .quantity-control button {
            cursor: pointer;
            border: 1px solid #ddd;
            background: white;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .quantity-control button:hover { background: #000; color: #fff; }
        
        .cart-footer {
            padding: 25px;
            border-top: 1px solid #eee;
            background: #fff;
        }
        .subtotal {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        .checkout-btn:disabled { background: #ccc; cursor: not-allowed; }
        .delete-item { color: #ff4d4d; cursor: pointer; }
    </style>
</head>
<body>

<div id="cartDrawer" class="cart-overlay">
    <div class="cart-container">
        <div class="cart-header">
            <h3>My Shopping Bag (<span id="cartCountHeader">0</span>)</h3>
            <i class="fa-solid fa-xmark close-cart" style="cursor:pointer" onclick="window.location.href='index.html'"></i>
        </div>

        <div class="cart-items" id="cartItemsList">
            </div>

        <div class="cart-footer" id="cartFooter">
            <div class="subtotal">
                <span>Subtotal</span>
                <span class="total-price" id="cartSubtotal">₦0.00</span>
            </div>
            <p style="font-size: 0.8rem; color: #888; margin-bottom: 15px;">Taxes and shipping calculated at checkout.</p>
            
            <button class="checkout-btn" id="checkoutBtn" onclick="goToCheckout()">
                Proceed to Checkout
            </button>
        </div>
    </div>
</div>

<script src="fetch.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        renderCart();
    });

    // 1. Render Cart with Stock Awareness
    async function renderCart() {
        const cartList = document.getElementById('cartItemsList');
        const countHeader = document.getElementById('cartCountHeader');
        const subtotalEl = document.getElementById('cartSubtotal');
        
        let cart = JSON.parse(localStorage.getItem('vicky_cart')) || [];
        countHeader.innerText = cart.length;

        if (cart.length === 0) {
            cartList.innerHTML = `
                <div style="text-align:center; margin-top:50px; color:#aaa;">
                    <i class="fa-solid fa-bag-shopping" style="font-size:3rem; margin-bottom:10px;"></i>
                    <p>Your luxury bag is empty.</p>
                    <a href="index.html" style="color:#000; text-decoration:underline;">Back to Shop</a>
                </div>`;
            subtotalEl.innerText = "₦0.00";
            document.getElementById('checkoutBtn').disabled = true;
            return;
        }

        // Fetch fresh product data to get current stock levels
        let allProducts = [];
        try {
            const response = await fetchAllProducts();
            allProducts = response?.data?.data || response?.data || [];
        } catch (e) { console.error("Could not refresh stock info", e); }

        cartList.innerHTML = '';
        let total = 0;

        cart.forEach((item, index) => {
            // Find stock for this specific item and size
            const productInfo = allProducts.find(p => p._id === item.id);
            const variant = productInfo?.variants?.find(v => v.size === item.size) || productInfo?.variants?.[0];
            const stockAvailable = variant ? variant.stock : 0;
            
            const isAtMax = item.quantity >= stockAvailable;
            total += (item.price * item.quantity);

            cartList.innerHTML += `
                <div class="cart-item">
                    <img src="${item.image}" alt="${item.name}" class="cart-item-img" onerror="this.src='https://via.placeholder.com/100'">
                    <div class="item-details">
                        <span class="item-name">${item.name}</span>
                        <small style="color: #666; display: block; margin-bottom: 4px;">Size: ${item.size || 'N/A'}</small>
                        <span class="item-price">₦${Number(item.price).toLocaleString()}</span>
                        
                        <div class="quantity-control">
                            <button onclick="updateQty(${index}, -1)">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="updateQty(${index}, 1)" 
                                ${isAtMax ? 'disabled style="opacity:0.4; cursor:not-allowed;"' : ''}>+</button>
                        </div>
                        ${isAtMax ? `<small style="color:red; font-size:10px;">Max stock reached</small>` : ''}
                    </div>
                    <i class="fa-regular fa-trash-can delete-item" onclick="removeItem(${index})"></i>
                </div>`;
        });

        subtotalEl.innerText = `₦${total.toLocaleString()}`;
        document.getElementById('checkoutBtn').disabled = false;
    }

    // 2. Async Update Quantity with Stock Validation
    async function updateQty(index, change) {
        let cart = JSON.parse(localStorage.getItem('vicky_cart'));
        const item = cart[index];

        if (change > 0) {
            try {
                const response = await fetchAllProducts();
                const products = response?.data?.data || response?.data || [];
                const productInfo = products.find(p => p._id === item.id);
                const variant = productInfo?.variants?.find(v => v.size === item.size) || productInfo?.variants?.[0];
                
                if (variant && item.quantity >= variant.stock) {
                    alert(`Only ${variant.stock} available for this item.`);
                    return;
                }
            } catch (err) {
                console.error("Stock check failed:", err);
            }
        }

        item.quantity += change;
        if (item.quantity < 1) item.quantity = 1;
        
        localStorage.setItem('vicky_cart', JSON.stringify(cart));
        renderCart();
    }

    function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem('vicky_cart'));
        cart.splice(index, 1);
        localStorage.setItem('vicky_cart', JSON.stringify(cart));
        renderCart();
    }

    // 3. Checkout Logic
    async function goToCheckout() {
        const token = localStorage.getItem('vicky_token');
        const cart = JSON.parse(localStorage.getItem('vicky_cart')) || [];

        if (!token) {
            alert("Please login to proceed.");
            window.location.href = 'signupform.html';
            return;
        }

        const checkoutBtn = document.getElementById('checkoutBtn');
        checkoutBtn.innerText = "Securing Transaction...";
        checkoutBtn.disabled = true;

        // Map items to include size for backend validation
        const items = cart.map(item => ({
            productId: item.id,
            name: item.name,
            size: item.size,
            qty: item.quantity
        }));

        try {
            const response = await fetch(`${IMG_PREFIX}/api/orders/checkout`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ items })
            });

            const data = await response.json();

            if (response.ok && data.paymentUrl) {
                window.location.href = data.paymentUrl;
            } else {
                if (response.status === 401) {
                    alert("Session expired. Please login again.");
                    window.location.href = 'signuoform.html';
                } else {
                    alert(data.message || "Checkout failed. Check stock levels.");
                }
                checkoutBtn.innerText = "Proceed to Checkout";
                checkoutBtn.disabled = false;
            }
        } catch (err) {
            alert("Network error. Please try again.");
            checkoutBtn.disabled = false;
        }
    }
</script>
</body>
</html>